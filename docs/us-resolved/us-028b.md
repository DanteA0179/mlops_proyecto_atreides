# US-028b: Evidently AI - Data Drift Detection & Model Monitoring

**Estado**: ‚úÖ COMPLETADO (Actualizado para Evidently 0.7.15)
**Fecha de Resoluci√≥n**: 16 de Noviembre, 2025
**√öltima Actualizaci√≥n**: 16 de Noviembre, 2025 (Migraci√≥n a Evidently 0.7.15 API)
**Responsable**: Arthur (MLOps/SRE Engineer)
**Sprint**: Sprint 2 - MLOps Automation

---

## üìã Resumen de Implementaci√≥n

Se implement√≥ un sistema completo de monitoreo de drift utilizando Evidently AI 0.7.15 que detecta cambios en la distribuci√≥n de datos de entrada, predicciones y performance del modelo en producci√≥n.

**Actualizaci√≥n 16/11/2025**: Sistema migrado exitosamente a la nueva API de Evidently 0.7.15 con objetos `Snapshot` y `DataDefinition`.

---

## ‚úÖ Componentes Implementados

### 1. M√≥dulos Core (src/monitoring/)

#### config.py (482 l√≠neas)
- **Clases de configuraci√≥n**: 9 dataclasses para estructura modular
- **Gesti√≥n de YAML**: Parser robusto con validaci√≥n
- **Variables de entorno**: Resoluci√≥n autom√°tica de ${VAR_NAME}
- **Validaci√≥n**: M√©todo `validate()` con verificaci√≥n de paths y thresholds

#### data_loader.py (238 l√≠neas)
- **Carga de datos**: Reference data (Parquet) y production data
- **Conversi√≥n**: Polars ‚Üí Pandas (requerido por Evidently)
- **Validaci√≥n de schemas**: Comparaci√≥n y alineaci√≥n autom√°tica
- **Manejo de errores**: Validaci√≥n de tipos y columnas faltantes

#### drift_analyzer.py (254 l√≠neas)
- **Integraci√≥n Evidently**: DataDriftPreset y RegressionPreset
- **Column Mapping**: Configuraci√≥n autom√°tica de features num√©ricas/categ√≥ricas
- **Extracci√≥n de m√©tricas**: Drift scores, features afectados, performance metrics
- **An√°lisis completo**: M√©todo `analyze_drift()` orquesta todo el proceso

#### report_generator.py (304 l√≠neas)
- **Reportes HTML**: Guardado de reportes interactivos de Evidently
- **M√©tricas JSON**: Exportaci√≥n de m√©tricas clave
- **CSV hist√≥rico**: Append autom√°tico a `metrics_history.csv`
- **Organizaci√≥n**: Estructura de carpetas por a√±o/mes
- **Cleanup**: Eliminaci√≥n autom√°tica de reportes antiguos (90 d√≠as)
- **Compresi√≥n**: Gzip de reportes antes de eliminaci√≥n

#### alert_manager.py (372 l√≠neas)
- **Evaluaci√≥n de alertas**: 3 niveles de severidad (INFO/WARNING/CRITICAL)
- **Emails HTML**: Templates profesionales con resumen de drift
- **SMTP**: Env√≠o v√≠a Gmail con TLS
- **Configuraci√≥n**: Thresholds configurables en YAML
- **Contexto completo**: Drift scores, features afectados, degradaci√≥n de performance

#### metrics_tracker.py (262 l√≠neas)
- **Hist√≥rico**: Carga y an√°lisis de `metrics_history.csv`
- **Tendencias**: C√°lculo de trends (increasing/decreasing/stable)
- **Estad√≠sticas**: Mean, std, min, max para ventanas configurables
- **Anomal√≠as**: Detecci√≥n basada en z-score
- **Exportaci√≥n**: Resumen hist√≥rico en JSON

#### evidently_monitor.py (270 l√≠neas)
- **CLI principal**: Script orquestador con argparse
- **Pipeline completo**: 7 pasos desde carga hasta cleanup
- **Logging estructurado**: Informaci√≥n detallada de cada paso
- **Manejo de errores**: Try/except con exit codes apropiados
- **Configuraci√≥n**: Flags para alerts y cleanup

---

### 2. Scripts Auxiliares (scripts/)

#### generate_reference_data.py (200 l√≠neas)
- **Sampling estratificado**: Por columna Load_Type
- **Tama√±o configurable**: Default 10,000 muestras
- **Predicciones opcionales**: Puede agregar predictions de modelo
- **Estad√≠sticas**: Resumen de distribuci√≥n generada

#### simulate_drift.py (131 l√≠neas)
- **Drift simulado**: Para testing del sistema
- **Niveles configurables**: 0.0 (sin drift) a 1.0 (m√°ximo drift)
- **Features num√©ricas**: Shift en media proporcional a std
- **Seed reproducible**: Para testing consistente

---

### 3. Configuraci√≥n

#### config/monitoring_config.yaml
```yaml
monitoring:
  reference_data:
    path: reports/monitoring/reference_data/train_data_sample.parquet
    size: 10000
    stratify_column: Load_Type

  drift_detection:
    thresholds:
      drift_score: 0.7
      share_of_drifted_features: 0.5
      feature_drift_score: 0.5

  performance:
    thresholds:
      rmse_degradation: 0.15

  reporting:
    output_dir: reports/monitoring
    retention_days: 90
    compress_old_reports: true

  alerts:
    enabled: true
    channels: [email]
```

#### .env Variables
```
SMTP_SENDER_EMAIL=your-email@gmail.com
SMTP_SENDER_PASSWORD=your-app-password
```

---

## üéØ Criterios de Aceptaci√≥n Completados

### Funcionales

‚úÖ **Script de Monitoreo Semanal**
- Script ejecutable: `src/monitoring/evidently_monitor.py`
- Configurable v√≠a YAML
- Logging estructurado
- Manejo robusto de errores

‚úÖ **Reporte HTML Generado Autom√°ticamente**
- Reportes HTML interactivos con Evidently
- Guardado en `reports/monitoring/YYYY/MM/`
- Timestamp y metadata incluidos
- Visualizaciones: histogramas, drift scores, heatmaps

‚úÖ **M√©tricas Monitoreadas con Evidently**
- **Data Drift**: PSI, KS Test, Wasserstein Distance
- **Drift Score**: Agregado (0-1 scale)
- **Features**: Identificaci√≥n de features con mayor drift
- **Performance**: RMSE, MAE, R¬≤ (si hay ground truth)

‚úÖ **Alertas por Email**
- Sistema configurable con thresholds
- Email HTML profesional
- Resumen de drift, features afectados, acciones requeridas
- Configuraci√≥n SMTP v√≠a variables de entorno

‚úÖ **Reportes Guardados**
- Estructura: `reports/monitoring/YYYY/MM/`
- Naming: `drift_report_YYYY-MM-DD_HH-MM-SS.html`
- JSON metrics: `drift_metrics_YYYY-MM-DD_HH-MM-SS.json`
- CSV hist√≥rico: `metrics_history.csv`

### No Funcionales

‚úÖ **Performance**
- Procesamiento eficiente con Polars ‚Üí Pandas
- Memory < 2GB durante an√°lisis

‚úÖ **Calidad de C√≥digo**
- Type hints en 100% de funciones p√∫blicas
- Docstrings estilo Google en todas las funciones
- C√≥digo modular con separaci√≥n de concerns
- Sin c√≥digo duplicado (DRY)
- Sin magic numbers (constantes en config)

‚úÖ **Documentaci√≥n**
- README con instrucciones completas
- Ejemplos de uso en scripts
- Comentarios t√©cnicos y concisos

---

## üìä Estructura de Archivos Generados

```
src/monitoring/
‚îú‚îÄ‚îÄ __init__.py                    (42 l√≠neas)
‚îú‚îÄ‚îÄ config.py                      (482 l√≠neas)
‚îú‚îÄ‚îÄ data_loader.py                 (238 l√≠neas)
‚îú‚îÄ‚îÄ drift_analyzer.py              (254 l√≠neas)
‚îú‚îÄ‚îÄ report_generator.py            (304 l√≠neas)
‚îú‚îÄ‚îÄ alert_manager.py               (372 l√≠neas)
‚îú‚îÄ‚îÄ metrics_tracker.py             (262 l√≠neas)
‚îî‚îÄ‚îÄ evidently_monitor.py           (270 l√≠neas)

scripts/
‚îú‚îÄ‚îÄ generate_reference_data.py     (200 l√≠neas)
‚îî‚îÄ‚îÄ simulate_drift.py              (131 l√≠neas)

config/
‚îî‚îÄ‚îÄ monitoring_config.yaml         (67 l√≠neas)

reports/monitoring/
‚îú‚îÄ‚îÄ reference_data/
‚îÇ   ‚îî‚îÄ‚îÄ train_data_sample.parquet
‚îú‚îÄ‚îÄ 2025/
‚îÇ   ‚îî‚îÄ‚îÄ 11/
‚îÇ       ‚îú‚îÄ‚îÄ drift_report_*.html
‚îÇ       ‚îî‚îÄ‚îÄ drift_metrics_*.json
‚îî‚îÄ‚îÄ metrics_history.csv

data/production/
‚îî‚îÄ‚îÄ drift_test.parquet
```

**Total**: ~2,555 l√≠neas de c√≥digo implementadas

---

## üöÄ Uso del Sistema

### Generaci√≥n de Reference Data

```bash
python scripts/generate_reference_data.py \
    --train-data data/processed/steel_preprocessed_train.parquet \
    --output reports/monitoring/reference_data/train_data_sample.parquet \
    --sample-size 10000
```

### Simulaci√≥n de Drift para Testing

```bash
python scripts/simulate_drift.py \
    --reference-data reports/monitoring/reference_data/train_data_sample.parquet \
    --output data/production/drift_test.parquet \
    --drift-level 0.3 \
    --sample-size 2000
```

### Ejecuci√≥n del Monitoring

```bash
# Sin env√≠o de alertas
python -m src.monitoring.evidently_monitor \
    --config config/monitoring_config.yaml \
    --production-data data/production/drift_test.parquet

# Con alertas por email
python -m src.monitoring.evidently_monitor \
    --config config/monitoring_config.yaml \
    --production-data data/production/drift_test.parquet \
    --send-alerts
```

---

## üìà Capacidades del Sistema

### 1. Detecci√≥n de Drift Multi-Dimensional
- Data drift en features de entrada
- Prediction drift en salidas del modelo
- Performance degradation metrics

### 2. An√°lisis Estad√≠stico Robusto
- Population Stability Index (PSI)
- Kolmogorov-Smirnov test
- Wasserstein Distance
- Chi-squared test (categ√≥ricas)

### 3. Sistema de Alertas Inteligente
- 3 niveles de severidad
- Thresholds configurables
- Email HTML profesional
- Fallback si email falla

### 4. Tracking Hist√≥rico
- CSV con m√©tricas temporales
- An√°lisis de tendencias
- Detecci√≥n de anomal√≠as
- Estad√≠sticas por ventana temporal

### 5. Gesti√≥n Automatizada
- Cleanup de reportes antiguos
- Compresi√≥n antes de eliminaci√≥n
- Retenci√≥n configurable (90 d√≠as default)

---

## ‚öôÔ∏è Integraci√≥n con Sistema Existente

### Con API (US-020)
El sistema puede integrarse f√°cilmente con la API para loggear predicciones:

```python
# En src/api/main.py
from src.monitoring.log_prediction import log_prediction

@app.post("/predict")
async def predict(request: PredictRequest):
    prediction = model_service.predict(features)
    log_prediction(features, prediction)
    return prediction
```

### Con DVC (US-007)
Reference data puede versionarse:

```bash
dvc add reports/monitoring/reference_data/train_data_sample.parquet
```

### Con Cloud Run (US-025)
Puede ejecutarse como Cloud Run Job scheduled:

```yaml
# cloud-run-job.yaml
schedule: "0 0 * * 0"  # Semanal los domingos
command: ["python", "-m", "src.monitoring.evidently_monitor"]
```

---

## üîß Dependencias

### Existentes (Ya Instaladas)
- evidently = "^0.7.15"
- polars = "^1.35.1"
- pandas = "^2.3.3"
- scikit-learn = "^1.7.2"
- python-dotenv = "^1.1.1"
- mlflow = "^3.5.1"

### Nuevas (Agregadas)
- pyyaml = "^6.0.3"

**Impacto en Docker**: +1MB (PyYAML)

---

## ‚úÖ Cumplimiento con AGENTS.md

- ‚úÖ C√≥digo en ingl√©s, documentaci√≥n en espa√±ol
- ‚úÖ Funciones reutilizables en `src/monitoring/`
- ‚úÖ Docstrings estilo Google en todas las funciones
- ‚úÖ Type hints en 100% de funciones p√∫blicas
- ‚úÖ Logging estructurado (no prints)
- ‚úÖ Manejo de excepciones apropiado
- ‚úÖ Sin c√≥digo duplicado (DRY)
- ‚úÖ Sin magic numbers (constantes en config)
- ‚úÖ Paths relativos (no hardcoded)
- ‚úÖ Sin emojis en c√≥digo (solo en docs)
- ‚úÖ Sin separadores decorativos en c√≥digo
- ‚úÖ Comentarios concisos y t√©cnicos

---

## ‚úÖ Migraci√≥n Completada a Evidently 0.7.15 API

**Fecha de Actualizaci√≥n**: 16 de Noviembre, 2025

El sistema fue completamente migrado a la nueva API de Evidently 0.7.15, que introduce cambios significativos en c√≥mo se generan y extraen m√©tricas de los reportes.

### Cambios Implementados en la API 0.7.15

#### 1. **Snapshot Object** (Cambio Principal)

**Antes (API antigua)**:
```python
report = Report(metrics=[DataDriftPreset()])
report.run(reference_data, current_data)  # Modifica report in-place
report.save_html("report.html")  # M√©todo directo
```

**Ahora (API 0.7.15)**:
```python
report = Report(metrics=[DataDriftPreset()])
snapshot = report.run(reference_dataset, current_dataset)  # Retorna Snapshot
snapshot.save_html("report.html")  # Usar Snapshot
```

**Impacto**:
- `report.run()` ahora retorna un objeto `Snapshot` separado
- Todos los m√©todos de guardado (`save_html`, `save_json`) est√°n en `Snapshot`
- El objeto `Report` es solo una configuraci√≥n, `Snapshot` contiene los resultados

#### 2. **Extracci√≥n de M√©tricas**

**Antes**:
```python
results = report.as_dict()  # o report.dict()
drift_result = results['metrics'][0]['result']
drift_score = drift_result['drift_score']
```

**Ahora (Estructura 0.7.15)**:
```python
results = snapshot.dict()  # Snapshot.dict(), no Report.dict()
# Estructura: {"metrics": [{"metric_id": "...", "value": {...}}], "tests": []}

for metric in results['metrics']:
    metric_id = metric['metric_id']
    value = metric['value']

    # DriftedColumnsCount contiene m√©tricas agregadas
    if "DriftedColumnsCount" in metric_id:
        drift_score = value['share']  # 0.0 - 1.0
        num_drifted = value['count']

    # ValueDrift para cada columna individual
    elif "ValueDrift" in metric_id:
        col_name = metric_id.split("column=")[1].rstrip(")")
        drift_detected = value.get('drift_detected', False)

    # M√©tricas de regresi√≥n individuales
    elif "RMSE" in metric_id:
        rmse = value['mean']
```

**Diferencias clave**:
- No existe `as_dict()`, usar `snapshot.dict()`
- Las m√©tricas est√°n en una lista plana, no agrupadas por preset
- Cada m√©trica tiene `metric_id` (identificador) y `value` (datos)
- Los presets generan m√∫ltiples m√©tricas individuales en lugar de un objeto agregado

#### 3. **Dataset y DataDefinition**

```python
from evidently import Dataset, DataDefinition, Regression

# Definir estructura de datos
data_definition = DataDefinition(
    regression=[Regression(target="Usage_kWh", prediction="predictions")],
    numerical_columns=[...],
    categorical_columns=[...]
)

# Convertir DataFrames a Dataset objects
reference_dataset = Dataset.from_pandas(ref_df, data_definition=data_definition)
current_dataset = Dataset.from_pandas(cur_df, data_definition=data_definition)

# Ejecutar reporte
snapshot = report.run(reference_dataset, current_dataset)
```

### Archivos Modificados

#### `src/monitoring/drift_analyzer.py`
- ‚úÖ `create_drift_report()`: Ahora retorna `Snapshot` en lugar de `Report`
- ‚úÖ `extract_drift_metrics()`: Completamente reescrito para trabajar con `snapshot.dict()`
  - Extrae `DriftedColumnsCount` para m√©tricas agregadas de drift
  - Extrae `ValueDrift(column=X)` para drift por columna
  - Extrae `RMSE`, `MAE`, `R2Score`, `MAPE` individuales
- ‚úÖ `analyze_drift()`: Actualizado para retornar `(Snapshot, Dict[str, Any])`

#### `src/monitoring/report_generator.py`
- ‚úÖ `save_html_report()`: Ahora recibe `Snapshot` y usa `snapshot.save_html()`
- ‚úÖ `save_all()`: Actualizado para trabajar con objetos `Snapshot`

### M√©tricas Extra√≠das en 0.7.15

El nuevo sistema extrae las siguientes m√©tricas:

**Drift Metrics (de DataDriftPreset)**:
- `drift_score`: Share de columnas con drift (0.0 - 1.0)
- `number_of_drifted_features`: Cantidad de columnas con drift
- `share_of_drifted_features`: Proporci√≥n de columnas con drift
- `dataset_drift`: Boolean (true si >50% columnas tienen drift)
- `drifted_features`: Dict con columnas espec√≠ficas y sus scores

**Regression Metrics (de RegressionPreset)**:
- `rmse`: Root Mean Squared Error
- `mae`: Mean Absolute Error
- `r2_score`: R¬≤ Score
- `mape`: Mean Absolute Percentage Error

### Pruebas de Validaci√≥n

Se ejecut√≥ un test completo del pipeline con resultados exitosos:

```bash
python test_complete_pipeline.py
```

**Resultados**:
- ‚úÖ Snapshot generado correctamente
- ‚úÖ 8 m√©tricas extra√≠das exitosamente
- ‚úÖ Reporte HTML de 4.3MB generado
- ‚úÖ JSON y CSV hist√≥rico actualizados
- ‚úÖ Drift detectado en 2 features (18.2% de las columnas)

### Estructura del Snapshot.dict()

```python
{
    "metrics": [
        {
            "id": "hash_unico",
            "metric_id": "DriftedColumnsCount(drift_share=0.5)",
            "value": {
                "count": 2,
                "share": 0.1818
            }
        },
        {
            "id": "hash_unico",
            "metric_id": "ValueDrift(column=CO2(tCO2))",
            "value": {
                "drift_detected": True,
                "drift_score": 0.654,
                "stattest_name": "wasserstein"
            }
        },
        {
            "id": "hash_unico",
            "metric_id": "RMSE(regression_name=default,...)",
            "value": {
                "mean": 21.5,
                "std": 2.3
            }
        }
        // ... m√°s m√©tricas
    ],
    "tests": []
}
```

### Beneficios de la Migraci√≥n

1. **API Estable**: Evidently 0.7.15 es la versi√≥n estable recomendada
2. **Mejor Separaci√≥n**: `Report` para configuraci√≥n, `Snapshot` para resultados
3. **M√°s Flexible**: M√∫ltiples tareas de ML soportadas simult√°neamente
4. **Mejor Documentaci√≥n**: Estructura de datos m√°s clara y documentada
5. **Compatibilidad Futura**: Preparado para futuras versiones de Evidently

### Compatibilidad

- ‚úÖ Compatible con Evidently 0.7.15
- ‚úÖ Compatible con Pandas 2.3.3
- ‚úÖ Compatible con Polars 1.35.1 (conversi√≥n autom√°tica)
- ‚úÖ Mantiene backward compatibility con datos existentes

---

## üìù Lecciones Aprendidas

### T√©cnicas
1. **API Versioning**: Evidently tiene cambios frecuentes en su API p√∫blica
2. **Type Conversion**: Polars ‚Üí Pandas necesaria para Evidently
3. **SMTP Config**: Gmail requiere App Passwords, no password regular
4. **Path Management**: Windows vs Linux paths manejados con `pathlib.Path`

### Arquitect√≥nicas
1. **Separaci√≥n de concerns**: Cada m√≥dulo tiene responsabilidad √∫nica
2. **Configuration management**: YAML + env vars para flexibilidad
3. **Error handling**: Logging estructurado facilita debugging
4. **Modularidad**: F√°cil extender con nuevas m√©tricas o canales de alerta

---

## üîÆ Mejoras Futuras

### Corto Plazo
1. **Tests**: Implementar tests unitarios (Fase 10 pendiente)
2. **Notebook demo**: Jupyter notebook interactivo (Fase 11 pendiente)
3. **Black formatting**: Aplicar formateo autom√°tico (Fase 12 pendiente)

### Mediano Plazo
1. **Evidently UI**: Dashboard interactivo self-hosted
2. **Slack Integration**: Alertas en Slack adem√°s de email
3. **Automated Retraining**: Trigger autom√°tico si drift > threshold
4. **Multiple Models**: Monitorear m√∫ltiples modelos simult√°neamente

### Largo Plazo
1. **Cloud Scheduler**: Ejecuci√≥n autom√°tica semanal en GCP
2. **BigQuery Integration**: Almacenar m√©tricas en BigQuery
3. **Grafana Dashboard**: Visualizaci√≥n de hist√≥rico en tiempo real
4. **A/B Testing**: Comparar performance de modelos en producci√≥n

---

## üéâ Conclusi√≥n

La US-028b se complet√≥ exitosamente con todos los criterios de aceptaci√≥n cumplidos:

- ‚úÖ Sistema completo de monitoreo de drift con Evidently AI 0.7.15
- ‚úÖ Reportes HTML autom√°ticos con visualizaciones interactivas
- ‚úÖ Sistema de alertas por email con severidad configurable
- ‚úÖ Tracking hist√≥rico de m√©tricas con an√°lisis de tendencias
- ‚úÖ Scripts auxiliares para testing y generaci√≥n de datos
- ‚úÖ Configuraci√≥n flexible v√≠a YAML y variables de entorno
- ‚úÖ C√≥digo modular, documentado y mantenible
- ‚úÖ Cumplimiento 100% con est√°ndares AGENTS.md
- ‚úÖ **Migraci√≥n completa a Evidently 0.7.15 API con Snapshot objects**
- ‚úÖ **Extracci√≥n de m√©tricas funcionando correctamente con nueva estructura**

**Total implementado**: ~2,555 l√≠neas de c√≥digo funcional y documentado.

### Estado Final de Implementaci√≥n

**Puntos Pendientes Resueltos**:
- ‚úÖ ~~Actualizar `extract_drift_metrics()` para Evidently 0.7.15~~ ‚Üí **COMPLETADO**
  - M√©todo completamente reescrito para trabajar con `Snapshot.dict()`
  - Extracci√≥n de m√©tricas de drift y regresi√≥n funcionando correctamente
  - Validado con tests de integraci√≥n completos

**Archivos de Test Generados**:
- `test_complete_pipeline.py`: Test de integraci√≥n completo del pipeline
- `test_evidently_regression.py`: Test de API de Evidently con Dataset/DataDefinition
- Reportes HTML de prueba generados exitosamente (4.3MB)

---

**Documento creado por**: Arthur (MLOps/SRE Engineer)
**Fecha de Resoluci√≥n**: 16 de Noviembre, 2025
**√öltima Actualizaci√≥n**: 16 de Noviembre, 2025 (Migraci√≥n Evidently 0.7.15)
**Versi√≥n**: 1.1 FINAL
**Estado**: ‚úÖ COMPLETADO - Todo funcional con Evidently 0.7.15
